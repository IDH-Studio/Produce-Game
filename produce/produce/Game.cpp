#include "Game.h"


Game::Game()
{
	setCursor(false);
	system("mode con: cols=160 Lines=45");
	createBuffer();

	select = SELECT::MENU;
	area = AREA::FACTORY;
	gameRun = true;
	isPause = false;
	
	objectCost.factoryCost = 80;
	objectCost.fiberCost = 100;
	objectCost.fabricCost.money = 100;
	objectCost.fabricCost.fiber = 10;

	pauseArrow.x = screenWidth / 2 - 7;
	pauseArrow.y = screenHeight / 2 - 1;
	pauseArrow.arrow = '>';

	for (int i = 0; i < objectSize; i++)
	{
		factory[i] = Factory(i);
		fiberFarm[i] = FiberFarm(i);
		fabricFactory[i] = FabricFactory(i);
	}

	player = new Player();
	store = new Store();

	factory[0].canBuy(player, 0);
}


Game::~Game()
{
	delete player;
	delete store;

	deleteBuffer();
}

void Game::update()
{
	int key = 0;

	if (!isPause)
	{
		for (int i = 0; i < objectSize; i++)
		{
			factory[i].update(player);
			fiberFarm[i].update(player);
		}

		if (store->isOpened())
		{
			store->update();
		}
		else
		{
			if (_kbhit())
			{
				key = _getch();

				if (inputError != INPUT_ERROR::NONE)
				{
					inputError = INPUT_ERROR::NONE;
				}
				else
				{
					if (area == AREA::FACTORY)
					{
						// °øÀå
						if (key == ARROW)
						{
							key = _getch();
							if (key == RIGHT_ARROW)
							{
								area = AREA::FIBER;
								select = MENU;
							}
						}
						else
						{
							switch (select)
							{
							case SELECT::MENU:
								if (key == '1')
									select = BUILD;
								else if (key == '2')
									select = DESTROY;
								else if (key == '3')
									store->visit(player);
								else if (key == ESCAPE)
									isPause = true;
								break;
							case SELECT::BUILD:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											char tryBuy = factory[number - 1].canBuy(player);
											if (tryBuy & CAN_OPEN)
											{
												//°øÀåÀ» »òÀ¸¸é
												select = MENU;
											}
											else if (tryBuy & CANT_OPEN)
											{
												//ÀÌ¹Ì ¿­·ÁÀÖÀ¸¸é
												inputError = INPUT_ERROR::EXIST;
											}
											else if (tryBuy & CANT_BUY)
											{
												//µ·ÀÌ ºÎÁ·ÇÏ¸é
												inputError = INPUT_ERROR::BUY;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							case SELECT::DESTROY:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											if (factory[number - 1].close())
											{
												//°øÀåÀ» ´Ý¾ÒÀ¸¸é
												select = MENU;
											}
											else
											{
												//°øÀåÀ» ¸ø ´Ý¾ÒÀ¸¸é(ÀÌ¹Ì ´ÝÇôÀÖÀ¸¸é)
												inputError = INPUT_ERROR::EXIST;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							}
						}
					}
					else if (area == AREA::FIBER)
					{
						// ¼¶À¯ ³óÀå
						if (key == ARROW)
						{
							key = _getch();
							if (key == LEFT_ARROW)
							{
								area = AREA::FACTORY;
								select = MENU;
							}
							else if (key == RIGHT_ARROW)
							{
								// ´Ù¸¥ Áö¿ªÀÌ »ý°åÀ» ¶§ Ãß°¡
								area = AREA::FABRIC;
								select = MENU;
							}
						}
						else
						{
							switch (select)
							{
							case SELECT::MENU:
								if (key == '1')
									select = BUILD;
								else if (key == '2')
									select = DESTROY;
								else if (key == '3')
									store->visit(player);
								else if (key == ESCAPE)
									isPause = true;
								break;
							case SELECT::BUILD:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											char tryBuy = fiberFarm[number - 1].canBuy(player);
											if (tryBuy & CAN_OPEN)
											{
												//¼¶À¯ ³óÀåÀ» »òÀ¸¸é
												select = MENU;
											}
											else if (tryBuy & CANT_OPEN)
											{
												//¼¶À¯ ³óÀåÀ» ¸ø»òÀ¸¸é(ÀÌ¹Ì »òÀ¸¸é)
												inputError = INPUT_ERROR::EXIST;
											}
											else if (tryBuy & CANT_BUY)
											{
												inputError = INPUT_ERROR::BUY;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							case SELECT::DESTROY:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											if (fiberFarm[number - 1].close())
											{
												//¼¶À¯ ³óÀåÀ» ´Ý¾ÒÀ¸¸é
												select = MENU;
											}
											else
											{
												//¼¶À¯ ³óÀåÀ» ¸ø ´Ý¾ÒÀ¸¸é(ÀÌ¹Ì ´ÝÇôÀÖÀ¸¸é)
												inputError = INPUT_ERROR::EXIST;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							}
						}
					}
					else if (area == AREA::FABRIC)
					{
						// ¼¶À¯ ³óÀå
						if (key == ARROW)
						{
							key = _getch();
							if (key == LEFT_ARROW)
							{
								area = AREA::FIBER;
								select = MENU;
							}
							else if (key == RIGHT_ARROW)
							{
								// ´Ù¸¥ Áö¿ªÀÌ »ý°åÀ» ¶§ Ãß°¡
								/**area = AREA::
								*select = MENU;*/
							}
						}
						else
						{
							switch (select)
							{
							case SELECT::MENU:
								if (key == '1')
									select = BUILD;
								else if (key == '2')
									select = DESTROY;
								else if (key == '3')
									store->visit(player);
								else if (key == ESCAPE)
									isPause = true;
								break;
							case SELECT::BUILD:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											char tryBuy = fabricFactory[number - 1].canBuy(player);
											if (tryBuy & CAN_OPEN)
											{
												//¼¶À¯ ³óÀåÀ» »òÀ¸¸é
												select = MENU;
											}
											else if (tryBuy & CANT_OPEN)
											{
												//¼¶À¯ ³óÀåÀ» ¸ø»òÀ¸¸é(ÀÌ¹Ì »òÀ¸¸é)
												inputError = INPUT_ERROR::EXIST;
											}
											else if (tryBuy & CANT_BUY)
											{
												inputError = INPUT_ERROR::BUY;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							case SELECT::DESTROY:
								if (key == ESCAPE)
									select = MENU;
								else
								{
									if ('1' <= key && key <= '6')
									{
										number = key % '0';

										if (1 <= number && number <= 6)
										{
											if (fabricFactory[number - 1].close())
											{
												//¼¶À¯ ³óÀåÀ» ´Ý¾ÒÀ¸¸é
												select = MENU;
											}
											else
											{
												//¼¶À¯ ³óÀåÀ» ¸ø ´Ý¾ÒÀ¸¸é(ÀÌ¹Ì ´ÝÇôÀÖÀ¸¸é)
												inputError = INPUT_ERROR::EXIST;
											}
										}
									}
									else
									{
										inputError = INPUT_ERROR::RANGE;
									}
								}
								break;
							}
						}
					}
				}
			}
		}
	}
	else
	{
		// ESC¸¦ ´­·¶À» ¶§
		if (_kbhit())
		{
			key = _getch();
			if (key == ARROW)
			{
				key = _getch();
				if (key == UP_ARROW && !(pauseState & PAUSE_RESUME))
				{
					pauseArrow.y -= 2;
					pauseState >>= 1;
				}
				else if (key == DOWN_ARROW && !(pauseState & PAUSE_EXIT))
				{
					pauseArrow.y += 2;
					pauseState <<= 1;
				}
			}
			else
			{
				if (key == ESCAPE)
					isPause = false;
				else if (key == ENTER)
				{
					if (pauseState & PAUSE_RESUME)
					{
						isPause = false;
					}
					else if (pauseState & PAUSE_EXIT)
					{
						gameRun = false;
					}
				}
			}
		}
	}
}

void Game::render()
{
	clearBuffer();

	if (!isPause)
	{
		writeBuffer(0, 31, "================================================================================================================================================================");

		if (store->isOpened())
		{
			store->render();
		}
		else
		{
			if (area == AREA::FACTORY)
			{
				writeBuffer(1, 43, "°øÀå");
				for (int i = 0; i < objectSize; i++)
				{
					factory[i].render();
				}

				if (inputError == INPUT_ERROR::NONE)
				{
					switch (select)
					{
					case SELECT::MENU:
						setColor(WHITE);
						writeBuffer(1, 32, "1. °øÀå »ý¼º");
						writeBuffer(1, 33, "2. °øÀå ÆÄ±â");
						writeBuffer(1, 34, "3. »óÁ¡");
						break;
					case SELECT::BUILD:
						setColor(WHITE);
						writeBuffer(1, 32, "°øÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					case SELECT::DESTROY:
						setColor(WHITE);
						writeBuffer(1, 32, "°øÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::EXIST)
				{
					switch (select)
					{
					case SELECT::BUILD:
						factory[number - 1].showError(1, 32, "active");
						break;
					case SELECT::DESTROY:
						factory[number - 1].showError(1, 32, "deactive");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::RANGE)
				{
					switch (select)
					{
					case SELECT::BUILD:
					case SELECT::DESTROY:
						factory[number - 1].showError(1, 32, "range");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::BUY)
				{
					factory[number - 1].showError(1, 32, "buy");
				}
			}
			else if (area == AREA::FIBER)
			{
				writeBuffer(1, 43, "¼¶À¯ ³óÀå");
				for (int i = 0; i < objectSize; i++)
				{
					fiberFarm[i].render();
				}

				if (inputError == INPUT_ERROR::NONE)
				{
					switch (select)
					{
					case SELECT::MENU:
						setColor(WHITE);
						writeBuffer(1, 32, "1. ¼¶À¯ ³óÀå »ý¼º");
						writeBuffer(1, 33, "2. ¼¶À¯ ³óÀå ÆÄ±â");
						writeBuffer(1, 34, "3. »óÁ¡");
						break;
					case SELECT::BUILD:
						setColor(WHITE);
						writeBuffer(1, 32, "¼¶À¯ ³óÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					case SELECT::DESTROY:
						setColor(WHITE);
						writeBuffer(1, 32, "¼¶À¯ ³óÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::EXIST)
				{
					switch (select)
					{
					case SELECT::BUILD:
						fiberFarm[number - 1].showError(1, 32, "active");
						break;
					case SELECT::DESTROY:
						fiberFarm[number - 1].showError(1, 32, "deactive");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::RANGE)
				{
					switch (select)
					{
					case SELECT::BUILD:
					case SELECT::DESTROY:
						fiberFarm[number - 1].showError(1, 32, "range");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::BUY)
				{
					fiberFarm[number - 1].showError(1, 32, "buy");
				}
			}
			else if (area == AREA::FABRIC)
			{
				writeBuffer(1, 43, "¼¶À¯ °øÀå");
				for (int i = 0; i < objectSize; i++)
				{
					fabricFactory[i].render();
				}

				if (inputError == INPUT_ERROR::NONE)
				{
					switch (select)
					{
					case SELECT::MENU:
						setColor(WHITE);
						writeBuffer(1, 32, "1. ¼¶À¯ °øÀå »ý¼º");
						writeBuffer(1, 33, "2. ¼¶À¯ °øÀå ÆÄ±â");
						writeBuffer(1, 34, "3. »óÁ¡");
						break;
					case SELECT::BUILD:
						setColor(WHITE);
						writeBuffer(1, 32, "¼¶À¯ °øÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					case SELECT::DESTROY:
						setColor(WHITE);
						writeBuffer(1, 32, "¼¶À¯ ³óÀå ¹øÈ£¸¦ ÀÔ·ÂÇØÁÖ¼¼¿ä(1 ~ 6)");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::EXIST)
				{
					switch (select)
					{
					case SELECT::BUILD:
						fabricFactory[number - 1].showError(1, 32, "active");
						break;
					case SELECT::DESTROY:
						fabricFactory[number - 1].showError(1, 32, "deactive");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::RANGE)
				{
					switch (select)
					{
					case SELECT::BUILD:
					case SELECT::DESTROY:
						fabricFactory[number - 1].showError(1, 32, "range");
						break;
					}
				}
				else if (inputError == INPUT_ERROR::BUY)
				{
					fabricFactory[number - 1].showError(1, 32, "buy");
				}
			}
		}

		player->renderInfo();
	}
	else
	{
		// ESC¸¦ ´­·¶À» ¶§
		// °ÔÀÓÀ¸·Î µ¹¾Æ°¡±â
		// °ÔÀÓ Á¾·á
		writeBuffer(screenWidth / 2 - 5, screenHeight / 2 - 1, "°ÔÀÓÀ¸·Î µ¹¾Æ°¡±â");
		writeBuffer(screenWidth / 2 - 2, screenHeight / 2 + 1, "°ÔÀÓ Á¾·á");
		writeBuffer(pauseArrow.x, pauseArrow.y, pauseArrow.arrow);
	}
	flippingBuffer();
}

void Game::run()
{
	while (gameRun)
	{
		update();
		render();
		Sleep(33);
	}
}